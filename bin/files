#!/usr/bin/env bash

# exit on error
set -e


# source of all words: a wordlist
# export FILES_WORDLIST=~/.my_own_private_wordlist
WORDFILE=/usr/share/dict/words
FILES_WORDLIST=${FILES_WORDLIST:-$WORDFILE}


# terminal colors
GREEN="\033[0;32m"
GREY="\033[1;30m"
RESET="\033[0m"


# usage info
usage() {
  cat <<EOF

  Usage: files [options] [number-of-files]

  Options:

    -f, --wordfile   Location of a wordfile
    -v, --version    Output version
    -h, --help       This message

  Examples:

    $ files
    $ files 10

EOF
}


#
# status message
#
# TODO pluralization
message() {
  if [ $number_of_folders -eq 0 ]; then
    echo -e "\n$GREY generated $GREEN$number_of_files files$GREY in current directory.$RESET"
  else
    echo -e "\n$GREY generated $GREEN$(( $number_of_files - $files_in_folder )) files$GREY in current directory and $GREEN$files_in_folder files$GREY in $GREEN$number_of_folders folders$GREY.$RESET"
  fi
}


#
# get array of N words from a wordlist $FILES_WORDLIST
#
words() {
  [ -z "$1" ] && echo "words() requires an argument" >&2 && exit 1

  local num=$1
  local w=()
  local list_length=$(cat $FILES_WORDLIST | wc -l)
  local MAX_RANDOM=32767   # http://wiki.bash-hackers.org/syntax/shellvars#random

  for (( i=0; i<num; i++ ))
  do
    local list_index=$(( $RANDOM * $list_length / $MAX_RANDOM + 1 ))
    local word=$(sed -n $(($list_index))p $FILES_WORDLIST | tr A-Z a-z)
    w[$i]=$word
  done
  echo "${w[@]}"
}


#
# create directory sequence and store in variable: folder > folder1 > folder2 > ...
#
mkdir_seq() {
  if [ -d $1 ] || [ -f $1 ]; then
    mkdir_seq $(seq $1)
  else
    mkdir $1
    echo $1
  fi
}


#
# return file sequence for
#   current directory: file > file1 > file2 > ...
#   or a given folder: folder/file > folder/file1 > folder/file2 > ...
#
file_seq() {
  if [[ -f $1 || -d $1 ]]; then
    file_seq $(seq $1)
  else
    echo $1
  fi
}


#
# make word sequence: word > word1 > word2 > ...
#
seq() {
  echo "$(echo $1 | tr -d 0-9)$(( $(echo $1 | tr -d /a-z) + 1 ))"
}

#
# parse command arguments
#
while test $# -ne 0; do
  arg=$1; shift
  case $arg in
    -h|--help)
      usage
      exit 1
      ;;
    *)
      if [[ $arg =~ [[:digit:]] ]]; then
        echo $arg
      fi
      ;;
  esac
done




# number of generated files (defaults to a random number between 10 and 20 if number is not given)
nofi=15
number_of_files=${nofi:-$(($RANDOM % 20 + 10))}

# number of generated folders (defaults to a random number between 1 and 3 if number is not given)
nofo=2
number_of_folders=${nofo:-$(($RANDOM % 3 + 1))}

# number of files within a folder (defaults to half of files)
fif=10
files_in_folder=${fif:-$(( $nofi / 2 ))}


# create folders and store folder names in array for later usage
folders=()
for word in $(words $number_of_folders)
do
  folder=$(mkdir_seq $word)
  folders=(${folders[@]} $folder)
done


# generate folders and files
i=0
for word in $(words $number_of_files)
do

  # create files in folders first ...
  if [ $i -lt $files_in_folder ] && [ $number_of_folders -gt 0 ]; then
    _word=$(file_seq ${folders[$(( $i % $number_of_folders ))]}/$word)
    echo $_word | sed 's/.*\///g' > $_word

  # ... and then files in current directory
  else
    _word=$(file_seq $word)
    echo $_word > $_word
  fi

  i=$(( $i + 1 ))
done

message
exit 0


# vim:ft=sh
